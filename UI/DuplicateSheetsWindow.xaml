<Window
    x:Class="ProSchedules.UI.DuplicateSheetsWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:av="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ProSchedules"
    xmlns:ui="clr-namespace:ProSchedules.UI"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Duplicate Sheets"
    Width="600"
    Height="600"
    MinWidth="400"
    MinHeight="500"
    AllowsTransparency="True"
    Background="Transparent"
    WindowStyle="None"
    mc:Ignorable="av">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary>
                    <SolidColorBrush x:Key="PrimaryBackgroundBrush" Color="#FF1F1F1F" />
                    <SolidColorBrush x:Key="SecondaryBackgroundBrush" Color="#FF292929" />
                    <SolidColorBrush x:Key="BorderBrush" Color="#FF444444" />
                    <SolidColorBrush x:Key="ForegroundBrush" Color="#EEEEEE" />
                </ResourceDictionary>
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.ComboBox.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Dark.xaml" />
                <ResourceDictionary Source="pack://application:,,,/ProSchedules;component/UI/Themes/ElementStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <Style x:Key="FullWidthGroupBoxStyle"
                   BasedOn="{StaticResource CustomGroupBoxStyle}"
                   TargetType="{x:Type GroupBox}">
                <Setter Property="Padding" Value="0" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type GroupBox}">
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="4"
                                    SnapsToDevicePixels="True">
                                <Border Background="{TemplateBinding Background}"
                                        CornerRadius="3"
                                        ClipToBounds="True"
                                        SnapsToDevicePixels="True">
                                    <ContentPresenter
                                        Margin="{TemplateBinding Padding}"
                                        SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                                </Border>
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="NegativeActionButtonStyle"
                   BasedOn="{StaticResource CustomActionButtonStyle}"
                   TargetType="{x:Type Button}">
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Button}">
                            <Border
                                x:Name="ButtonBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="5">
                                <ContentPresenter
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Content="{TemplateBinding Content}" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="ButtonBorder" Property="Opacity" Value="0.85" />
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="ButtonBorder" Property="Opacity" Value="0.7" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Dark Theme ComboBox -->
            <Style x:Key="DarkComboBoxStyle" TargetType="{x:Type ComboBox}">
                <Setter Property="Background" Value="{DynamicResource SecondaryBackgroundBrush}"/>
                <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="Padding" Value="8,4"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type ComboBox}">
                            <Grid>
                                <ToggleButton x:Name="ToggleButton"
                                              Grid.Column="0"
                                              Background="Transparent"
                                              BorderThickness="0"
                                              Focusable="False"
                                              IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                              ClickMode="Press">
                                    <ToggleButton.Template>
                                        <ControlTemplate TargetType="ToggleButton">
                                            <Border x:Name="Border"
                                                    Background="{DynamicResource SecondaryBackgroundBrush}"
                                                    BorderBrush="{DynamicResource BorderBrush}"
                                                    BorderThickness="1"
                                                    CornerRadius="4">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <ContentPresenter Grid.Column="0"
                                                                      Content="{Binding SelectionBoxItem, RelativeSource={RelativeSource AncestorType=ComboBox}}"
                                                                      ContentTemplate="{Binding SelectionBoxItemTemplate, RelativeSource={RelativeSource AncestorType=ComboBox}}"
                                                                      Margin="8,4"
                                                                      VerticalAlignment="Center"
                                                                      HorizontalAlignment="Left"
                                                                      TextElement.Foreground="{DynamicResource ForegroundBrush}"/>
                                                    <materialDesign:PackIcon Grid.Column="1"
                                                                             Kind="ChevronDown"
                                                                             Width="16"
                                                                             Height="16"
                                                                             Foreground="{DynamicResource ForegroundBrush}"
                                                                             Margin="0,0,8,0"
                                                                             VerticalAlignment="Center"/>
                                                </Grid>
                                            </Border>
                                        </ControlTemplate>
                                    </ToggleButton.Template>
                                </ToggleButton>
                                <Popup x:Name="Popup"
                                       Placement="Bottom"
                                       IsOpen="{TemplateBinding IsDropDownOpen}"
                                       AllowsTransparency="True"
                                       Focusable="False"
                                       PopupAnimation="Slide">
                                    <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="4"
                                            MinWidth="{TemplateBinding ActualWidth}"
                                            MaxHeight="200">
                                        <ScrollViewer>
                                            <StackPanel IsItemsHost="True"/>
                                        </ScrollViewer>
                                    </Border>
                                </Popup>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Setter Property="ItemContainerStyle">
                    <Setter.Value>
                        <Style TargetType="{x:Type ComboBoxItem}">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
                            <Setter Property="Padding" Value="8,4"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#FF3A3A3A"/>
                                </Trigger>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#FF2D5F8D"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Custom CheckBox Style with MaterialDesign Icons -->
            <Style x:Key="CustomCheckBoxStyle" TargetType="{x:Type CheckBox}">
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type CheckBox}">
                            <Border Background="Transparent" Cursor="Hand">
                                <Grid Background="Transparent">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <materialDesign:PackIcon
                                            x:Name="CheckboxIcon"
                                            Width="20" Height="20"
                                            Foreground="{DynamicResource BorderBrush}"
                                            Kind="CheckboxBlankOutline" />
                                        <ContentPresenter
                                            Margin="5,0,0,0"
                                            VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <!-- invisible overlay to make whole area clickable -->
                                    <Border Background="Transparent" />
                                </Grid>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter TargetName="CheckboxIcon" Property="Kind" Value="CheckboxMarkedOutline" />
                                    <Setter TargetName="CheckboxIcon" Property="Foreground" Value="{DynamicResource ForegroundBrush}" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
            
            <!-- Dark Theme CheckBox (for itemize) -->
            <Style x:Key="DarkCheckBoxStyle" TargetType="{x:Type CheckBox}" BasedOn="{StaticResource CustomCheckBoxStyle}"/>

            <!-- DataGrid Header Style -->
            <Style x:Key="DataGridColumnHeaderStyle" TargetType="{x:Type DataGridColumnHeader}">
                <Setter Property="Background" Value="{DynamicResource SecondaryBackgroundBrush}"/>
                <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                <Setter Property="BorderThickness" Value="0,0,1,1"/>
                <Setter Property="Padding" Value="8,4"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="HorizontalContentAlignment" Value="Left"/>
            </Style>

            
        </ResourceDictionary>
    </Window.Resources>


    <Grid Background="Transparent" ClipToBounds="True">
        <!-- Outer Border with Opacity and Blur -->
        <Border
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="2"
            ClipToBounds="True"
            CornerRadius="10"
            Opacity="0.7"
            SnapsToDevicePixels="True">
            <Border.Effect>
                <BlurEffect KernelType="Gaussian" Radius="2" />
            </Border.Effect>
        </Border>

        <!-- Content Container -->
        <Border
            Margin="2"
            Background="{DynamicResource PrimaryBackgroundBrush}"
            CornerRadius="10">
            <Grid PreviewMouseDown="Window_PreviewMouseDown">
                <Grid.RowDefinitions>
                    <RowDefinition Height="30" />
                    <!-- Row 0: Title bar -->
                    <RowDefinition Height="*" />
                    <!-- Row 1: Content -->
                    <RowDefinition Height="Auto" />
                    <!-- Row 2: Actions -->
                </Grid.RowDefinitions>

                <!-- Title bar (Row 0) -->
                <ui:TitleBar
                    Grid.Row="0"
                    Foreground="{DynamicResource ForegroundBrush}"
                    Loaded="TitleBar_Loaded" />

                <!-- Theme toggle -->
                <ToggleButton
                    x:Name="ThemeToggleButton"
                    Grid.Row="0"
                    Width="28"
                    Height="15.5"
                    Margin="0,0,70,0"
                    HorizontalAlignment="Right"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    Click="ToggleTheme_Click"
                    IsChecked="True"
                    ToolTip="Toggle Theme">
                    <ToggleButton.Template>
                        <ControlTemplate TargetType="{x:Type ToggleButton}">
                            <Grid Background="Transparent">
                                <materialDesign:PackIcon
                                    x:Name="ThemeToggleIcon"
                                    Width="30"
                                    Height="30"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Foreground="{DynamicResource IconBrush}"
                                    Kind="ToggleSwitchOffOutline" />
                            </Grid>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter TargetName="ThemeToggleIcon" Property="Kind" Value="ToggleSwitchOffOutline" />
                                </Trigger>
                                <Trigger Property="IsChecked" Value="False">
                                    <Setter TargetName="ThemeToggleIcon" Property="Kind" Value="ToggleSwitchOutline" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </ToggleButton.Template>
                </ToggleButton>

                <!-- Main Content (Row 1) -->
                <Grid Grid.Row="1" Margin="10,10,10,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Top Bar -->
                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Left">
                            <Button Content="Duplicate"
                                    Click="AddDuplicates_Click"
                                    Style="{StaticResource CustomActionButtonStyle}"
                                    Width="140" Height="32" FontSize="12" FontWeight="Bold"
                                    Margin="0,0,6,0"/>

                            <Button Content="Rename"
                                    Click="Rename_Click"
                                    Style="{StaticResource CustomActionButtonStyle}"
                                    Width="100" Height="32" FontSize="12" FontWeight="Bold"
                                    Margin="0,0,6,0"/>

                            <Button Content="Parameters"
                                    Click="Parameters_Click"
                                    Style="{StaticResource CustomActionButtonStyle}"
                                    Width="120" Height="32" FontSize="12" FontWeight="Bold"
                                    Margin="0,0,6,0"/>

                            <Button Content="Delete"
                                    Click="Delete_Click"
                                    Style="{StaticResource CustomActionButtonStyle}"
                                    Width="100" Height="32" FontSize="12" FontWeight="Bold"
                                    Margin="0,0,6,0"/>
                        </StackPanel>

                        <!-- Schedule Select and Itemize -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Left" Margin="10,0,0,0">
                            <ComboBox x:Name="SchedulesComboBox"
                                      Width="200"
                                      Height="32"
                                      Margin="0,0,10,0"
                                      SelectionChanged="SchedulesComboBox_SelectionChanged"
                                      DisplayMemberPath="Name"
                                      Style="{StaticResource DarkComboBoxStyle}"/>
                            
                            <CheckBox x:Name="ItemizeCheckBox"
                                      Content="Itemize every instance"
                                      VerticalAlignment="Center"
                                      Foreground="{DynamicResource ForegroundBrush}"
                                      Checked="Itemize_Checked"
                                      Unchecked="Itemize_Unchecked"
                                      IsChecked="True"
                                      Margin="0,0,10,0"
                                      Style="{StaticResource DarkCheckBoxStyle}"/>
                        </StackPanel>

                        <!-- Search Box with Magnify Icon -->
                        <Border Grid.Column="1"
                                Width="240"
                                Height="24"
                                HorizontalAlignment="Right"
                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Opacity="0.95">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="28"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="28"/>
                                </Grid.ColumnDefinitions>

                                <materialDesign:PackIcon Kind="Magnify"
                                                       Grid.Column="0"
                                                       Width="16" Height="16"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       Foreground="{DynamicResource IconBrush}"/>

                                <TextBlock Grid.Column="1"
                                          Text="Search sheets..."
                                          Foreground="#FF808080"
                                          VerticalAlignment="Center"
                                          Margin="2,0,0,0"
                                          IsHitTestVisible="False">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Text, ElementName=SheetSearchBox}" Value="">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>

                                <TextBox Grid.Column="1"
                                         x:Name="SheetSearchBox"
                                         Style="{StaticResource CustomTextBoxStyle}"
                                         Height="Auto"
                                         VerticalAlignment="Center"
                                         HorizontalAlignment="Stretch"
                                         Background="Transparent"
                                         BorderThickness="0"
                                         TextChanged="SheetSearch_TextChanged"/>

                                <Button Grid.Column="2"
                                        Width="24"
                                        Height="24"
                                        Click="ClearSheetSearch_Click"
                                        ToolTip="Clear search"
                                        Style="{StaticResource FlatIconButton}">
                                    <materialDesign:PackIcon Kind="CloseCircleOutline" 
                                                            Width="14" 
                                                            Height="14"
                                                            Foreground="{DynamicResource IconBrush}"/>
                                </Button>
                            </Grid>
                        </Border>
                    </Grid>

                    <!-- Sheets List -->
                    <!-- Removed title by setting Header to null/empty and ensuring style handles it, or just empty string -->
                    <GroupBox Grid.Row="1" Grid.Column="0" Header="{x:Null}" 
                              Margin="0"
                              Style="{StaticResource FullWidthGroupBoxStyle}">
                        <Grid>
                            <DataGrid
                                      x:Name="SheetsDataGrid"
                                      ItemsSource="{Binding FilteredSheets}" 
                                      AutoGenerateColumns="False" 
                                      CanUserAddRows="False" 
                                      CanUserDeleteRows="False" 
                                      CanUserResizeRows="False"
                                      Style="{StaticResource CustomDataGridStyle}"
                                      ColumnHeaderStyle="{StaticResource DataGridColumnHeaderStyle}"
                                      CellStyle="{StaticResource CustomDataGridCellStyle}"
                                      SelectionMode="Extended"
                                      SelectionUnit="FullRow"
                                      AlternationCount="2"
                                      RowStyle="{StaticResource CustomDataGridRowStyle}"
                                      RowHeight="20"
                                      GridLinesVisibility="None"
                                      HeadersVisibility="Column"
                                      RowHeaderWidth="0"
                                      Background="{DynamicResource PrimaryBackgroundBrush}"
                                      Margin="0,1,0,0"
                                      HorizontalScrollBarVisibility="Disabled"
                                      VerticalScrollBarVisibility="Auto"
                                      KeyDown="SheetsDataGrid_KeyDown">
                                <DataGrid.Columns>
                                    <DataGridTemplateColumn Width="35" HeaderStyle="{StaticResource MultiRowHeaderStyle}">
                                        <DataGridTemplateColumn.Header>
                                            <CheckBox Style="{StaticResource DatagridCheckboxStyle}"
                                                      HorizontalAlignment="Center"
                                                      Checked="SelectAllSheets_Checked"
                                                      Unchecked="SelectAllSheets_Unchecked"
                                                      ToolTip="Select/Deselect All Visible"/>
                                        </DataGridTemplateColumn.Header>
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                                                    <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                             Style="{StaticResource DatagridCheckboxStyle}"
                                                             Focusable="False"
                                                             PreviewMouseLeftButtonDown="SheetCheckBox_PreviewMouseLeftButtonDown"/>
                                                </Grid>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Nr"
                                                        Binding="{Binding SheetNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                        IsReadOnly="False"
                                                        Width="SizeToCells"
                                                        HeaderStyle="{StaticResource MultiRowHeaderStyle}"
                                                        ElementStyle="{StaticResource EditableCellStyle}"/>
                                    <DataGridTextColumn Header="Name"
                                                        Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                        IsReadOnly="False"
                                                        Width="*"
                                                        HeaderStyle="{StaticResource MultiRowHeaderStyle_NoRightBorder}"
                                                        ElementStyle="{StaticResource EditableCellStyle}"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </GroupBox>
                </Grid>

                <!-- Actions (Row 2) -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,15,0,15">
                    <Button x:Name="ApplyButton"
                            Content="Apply Changes"
                            Click="Apply_Click"
                            Style="{StaticResource CustomActionButtonStyle}"
                            Width="140" Height="40" FontSize="12" FontWeight="Bold"
                            Margin="3,0"
                            IsEnabled="False"/>

                    <Button x:Name="DiscardButton"
                            Content="Discard Pending"
                            Click="DiscardPending_Click"
                            Style="{StaticResource NegativeActionButtonStyle}"
                            Background="#FF555555"
                            BorderBrush="#FF555555"
                            Width="140" Height="40" FontSize="12" FontWeight="Bold"
                            Margin="3,0"
                            IsEnabled="False"/>
                </StackPanel>

                <!-- Duplicate Options Popup Overlay -->
                <Grid x:Name="OptionsPopupOverlay" Grid.RowSpan="3" Visibility="Collapsed" Panel.ZIndex="1050">
                     <!-- Dim Background -->
                     <Border Background="#90000000" MouseLeftButtonDown="OptionsPopupBackground_Click"/>

                     <!-- Options Content -->
                     <Border HorizontalAlignment="Center" 
                             VerticalAlignment="Center"
                             Width="400"
                             Padding="20"
                             Background="{DynamicResource PrimaryBackgroundBrush}"
                             BorderBrush="{DynamicResource BorderBrush}"
                             BorderThickness="1"
                             CornerRadius="8">
                         <Border.Effect>
                             <DropShadowEffect BlurRadius="15" Direction="-90" RenderingBias="Quality" ShadowDepth="2" Opacity="0.4"/>
                         </Border.Effect>

                         <StackPanel>
                             <TextBlock Text="Duplicate Options" 
                                        FontSize="18" 
                                        FontWeight="Bold" 
                                        Foreground="{DynamicResource ForegroundBrush}"
                                        Margin="0,0,0,15"
                                        HorizontalAlignment="Center"/>

                             <!-- Form Layout Grid -->
                             <Grid Margin="0,0,0,15">
                                 <Grid.RowDefinitions>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                 </Grid.RowDefinitions>
                                 <Grid.ColumnDefinitions>
                                     <ColumnDefinition Width="Auto"/>
                                     <ColumnDefinition Width="*"/>
                                 </Grid.ColumnDefinitions>

                                 <!-- Row 0: Copies -->
                                 <TextBlock Grid.Row="0" Grid.Column="0" 
                                            Text="Copies:" 
                                            VerticalAlignment="Center" 
                                            Foreground="{DynamicResource ForegroundBrush}"
                                            Margin="0,0,15,0"/>
                                 <TextBox x:Name="OptCopies" Grid.Row="0" Grid.Column="1" 
                                          Width="60" 
                                          Text="1" 
                                          Style="{StaticResource CustomTextBoxStyle}"
                                          HorizontalAlignment="Right"
                                          HorizontalContentAlignment="Center"/>

                                 <!-- Row 1: Duplicate Type replaced by checkbox logic below -->
                             </Grid>

                             <!-- Checkboxes -->
                             <CheckBox x:Name="OptKeepViews" Content="Keep Views" IsChecked="False" Margin="0,5" Foreground="{DynamicResource ForegroundBrush}" Style="{StaticResource CustomCheckboxStyle}"/>
                             <CheckBox x:Name="OptKeepLegends" Content="Keep Legends" IsChecked="False" Margin="0,5" Foreground="{DynamicResource ForegroundBrush}" Style="{StaticResource CustomCheckboxStyle}"/>
                             <CheckBox x:Name="OptKeepSchedules" Content="Keep Schedules" IsChecked="False" Margin="0,5" Foreground="{DynamicResource ForegroundBrush}" Style="{StaticResource CustomCheckboxStyle}"/>
                             <CheckBox x:Name="OptCopyRevisions" Content="Copy Revisions" IsChecked="True" Margin="0,5" Foreground="{DynamicResource ForegroundBrush}" Style="{StaticResource CustomCheckboxStyle}"/>
                             <CheckBox x:Name="OptCopyParams" Content="Copy Title Block Parameter Values" IsChecked="True" Margin="0,5" Foreground="{DynamicResource ForegroundBrush}" Style="{StaticResource CustomCheckboxStyle}"/>

                             <!-- Action Buttons -->
                             <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,25,0,0">
                                 <Button Content="Duplicate" 
                                         Click="DuplicateConfirm_Click"
                                         Style="{StaticResource CustomActionButtonStyle}"
                                         Width="120" Height="35"
                                         FontSize="12"
                                         Margin="5,0,5,0"/>
                                 
                                 <Button Content="Cancel" 
                                         Click="DuplicateCancel_Click"
                                         Style="{StaticResource NegativeActionButtonStyle}"
                                         Background="#FF555555"
                                         BorderBrush="#FF555555"
                                         Width="120" Height="35"
                                         FontSize="12"
                                         Margin="5,0,5,0"/>
                             </StackPanel>
                         </StackPanel>
                     </Border>
                </Grid>

                <!-- Generic Popup Overlay (Keep for errors etc) -->
                <Grid x:Name="PopupOverlay" Grid.RowSpan="3" Visibility="Collapsed" Panel.ZIndex="1000">
                    <!-- Dim Background -->
                    <Border Background="#80000000" MouseLeftButtonDown="PopupBackground_Click"/>

                    <!-- Popup Content -->
                    <Border HorizontalAlignment="Center" 
                            VerticalAlignment="Center"
                            Width="300"
                            Padding="20"
                            Background="{DynamicResource PrimaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="8">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="15" Direction="-90" RenderingBias="Quality" ShadowDepth="2" Opacity="0.4"/>
                        </Border.Effect>

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock x:Name="PopupTitle" 
                                       Grid.Row="0"
                                       Text="Title" 
                                       FontSize="16" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,10"/>

                            <TextBlock x:Name="PopupMessage" 
                                       Grid.Row="1"
                                       Text="Message content goes here." 
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,20"/>

                            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button x:Name="PopupCloseButton"
                                        Content="OK"
                                        Click="PopupClose_Click"
                                        Style="{StaticResource CustomActionButtonStyle}"
                                        Width="80" 
                                        Height="30"
                                        FontSize="12"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Confirm Popup Overlay -->
                <Grid x:Name="ConfirmPopupOverlay" Grid.RowSpan="3" Visibility="Collapsed" Panel.ZIndex="1100">
                    <!-- Dim Background -->
                    <Border Background="#80000000" MouseLeftButtonDown="ConfirmPopupBackground_Click"/>

                    <!-- Popup Content -->
                    <Border HorizontalAlignment="Center" 
                            VerticalAlignment="Center"
                            Width="320"
                            Padding="20"
                            Background="{DynamicResource PrimaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="8">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="15" Direction="-90" RenderingBias="Quality" ShadowDepth="2" Opacity="0.4"/>
                        </Border.Effect>

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock x:Name="ConfirmPopupTitle" 
                                       Grid.Row="0"
                                       Text="Title" 
                                       FontSize="16" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,10"/>

                            <TextBlock x:Name="ConfirmPopupMessage" 
                                       Grid.Row="1"
                                       Text="Message content goes here." 
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,20"/>

                            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button x:Name="ConfirmActionButton"
                                        Content="Discard"
                                        Click="ConfirmDiscard_Click"
                                        Style="{StaticResource CustomActionButtonStyle}"
                                        Width="90" 
                                        Height="30"
                                        FontSize="12"
                                        Margin="0,0,8,0"/>
                                <Button Content="Cancel"
                                        Click="ConfirmCancel_Click"
                                        Style="{StaticResource NegativeActionButtonStyle}"
                                        Background="#FF555555"
                                        BorderBrush="#FF555555"
                                        Width="90" 
                                        Height="30"
                                        FontSize="12"
                                        Margin="0"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Delete Confirm Popup Overlay -->
                <Grid x:Name="DeleteConfirmPopupOverlay" Grid.RowSpan="3" Visibility="Collapsed" Panel.ZIndex="1100">
                    <!-- Dim Background -->
                    <Border Background="#80000000" MouseLeftButtonDown="DeleteConfirmPopupBackground_Click"/>

                    <!-- Popup Content -->
                    <Border HorizontalAlignment="Center" 
                            VerticalAlignment="Center"
                            Width="360"
                            Padding="20"
                            Background="{DynamicResource PrimaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="8">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="15" Direction="-90" RenderingBias="Quality" ShadowDepth="2" Opacity="0.4"/>
                        </Border.Effect>

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock x:Name="DeleteConfirmPopupTitle" 
                                       Grid.Row="0"
                                       Text="Delete Sheets" 
                                       FontSize="16" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,10"/>

                            <TextBlock x:Name="DeleteConfirmPopupMessage" 
                                       Grid.Row="1"
                                       Text="Delete confirmation message." 
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,20"/>

                            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="Cancel"
                                        Click="DeleteConfirmCancel_Click"
                                        Style="{StaticResource NegativeActionButtonStyle}"
                                        Background="#FF555555"
                                        BorderBrush="#FF555555"
                                        Width="90" 
                                        Height="30"
                                        FontSize="12"
                                        Margin="0,0,8,0"/>
                                <Button Content="OK"
                                        Click="DeleteConfirmOk_Click"
                                        Style="{StaticResource CustomActionButtonStyle}"
                                        Width="90" 
                                        Height="30"
                                        FontSize="12"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Parameters Popup Overlay -->
                <Grid x:Name="ParametersPopupOverlay" Grid.RowSpan="3" Visibility="Collapsed" Panel.ZIndex="1050">
                    <!-- Dim Background -->
                    <Border Background="#80000000" MouseLeftButtonDown="ParametersPopupBackground_Click"/>

                    <!-- Popup Content -->
                    <Border HorizontalAlignment="Center" 
                            VerticalAlignment="Center"
                            Width="360"
                            Padding="20"
                            Background="{DynamicResource PrimaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="8">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="15" Direction="-90" RenderingBias="Quality" ShadowDepth="2" Opacity="0.4"/>
                        </Border.Effect>

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0"
                                       Text="Parameters"
                                       FontSize="16"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,10"
                                       HorizontalAlignment="Center"/>

                            <TextBlock Grid.Row="1"
                                       Text="Parameter tools coming soon."
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,20"/>

                            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="Close"
                                        Click="ParametersClose_Click"
                                        Style="{StaticResource CustomActionButtonStyle}"
                                        Width="90" 
                                        Height="30"
                                        FontSize="12"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Rename Popup Overlay -->
                <Grid x:Name="RenamePopupOverlay" Grid.RowSpan="3" Visibility="Collapsed" Panel.ZIndex="1050">
                    <!-- Dim Background -->
                    <Border Background="#90000000" MouseLeftButtonDown="RenamePopupBackground_Click"/>

                    <!-- Rename Content -->
                    <Border HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Width="500"
                            MaxHeight="700"
                            Padding="20"
                            Background="{DynamicResource PrimaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="8">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="15" Direction="-90" RenderingBias="Quality" ShadowDepth="2" Opacity="0.4"/>
                        </Border.Effect>

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Title -->
                            <TextBlock Grid.Row="0"
                                       Text="Batch Rename parameter values"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,15"
                                       HorizontalAlignment="Center"/>

                            <!-- Rename Options -->
                            <Grid Grid.Row="1" Margin="0,0,0,15">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Parameter -->
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Parameter:"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource ForegroundBrush}"
                                           Margin="0,0,15,10"/>
                                <ComboBox x:Name="RenameParameter"
                                          Grid.Row="0" Grid.Column="1"
                                          Width="220"
                                          HorizontalAlignment="Left"
                                          SelectedIndex="0"
                                          Margin="0,0,0,10"
                                          SelectionChanged="RenameParameter_Changed"
                                          Style="{StaticResource DarkThemeComboBox}">
                                    <ComboBoxItem Content="Sheet Number"/>
                                    <ComboBoxItem Content="Sheet Name"/>
                                </ComboBox>

                                <!-- Find -->
                                <TextBlock Grid.Row="1" Grid.Column="0"
                                           Text="Find:"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource ForegroundBrush}"
                                           Margin="0,0,15,10"/>
                                <TextBox x:Name="RenameFindText"
                                         Grid.Row="1" Grid.Column="1"
                                         Width="220"
                                         HorizontalAlignment="Left"
                                         Style="{StaticResource CustomTextBoxStyle}"
                                         Margin="0,0,0,10"
                                         TextChanged="RenameText_Changed"/>

                                <!-- Replace -->
                                <TextBlock Grid.Row="2" Grid.Column="0"
                                           Text="Replace:"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource ForegroundBrush}"
                                           Margin="0,0,15,10"/>
                                <TextBox x:Name="RenameReplaceText"
                                         Grid.Row="2" Grid.Column="1"
                                         Width="220"
                                         HorizontalAlignment="Left"
                                         Style="{StaticResource CustomTextBoxStyle}"
                                         Margin="0,0,0,10"
                                         TextChanged="RenameText_Changed"/>

                                <!-- Prefix -->
                                <TextBlock Grid.Row="3" Grid.Column="0"
                                           Text="Prefix:"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource ForegroundBrush}"
                                           Margin="0,0,15,10"/>
                                <TextBox x:Name="RenamePrefixText"
                                         Grid.Row="3" Grid.Column="1"
                                         Width="220"
                                         HorizontalAlignment="Left"
                                         Style="{StaticResource CustomTextBoxStyle}"
                                         Margin="0,0,0,10"
                                         TextChanged="RenameText_Changed"/>

                                <!-- Suffix -->
                                <TextBlock Grid.Row="4" Grid.Column="0"
                                           Text="Suffix:"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource ForegroundBrush}"
                                           Margin="0,0,15,0"/>
                                <TextBox x:Name="RenameSuffixText"
                                         Grid.Row="4" Grid.Column="1"
                                         Width="220"
                                         HorizontalAlignment="Left"
                                         Style="{StaticResource CustomTextBoxStyle}"
                                         TextChanged="RenameText_Changed"/>
                            </Grid>

                            <!-- Preview List -->
                            <Border Grid.Row="2"
                                    Background="{DynamicResource SecondaryBackgroundBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Margin="0,0,0,15">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0"
                                               Text="Preview"
                                               FontSize="14"
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource ForegroundBrush}"
                                               Margin="10,10,10,5"/>

                                    <DataGrid Grid.Row="1"
                                              x:Name="RenamePreviewDataGrid"
                                              ItemsSource="{Binding RenamePreviewItems}"
                                              AutoGenerateColumns="False"
                                              IsReadOnly="True"
                                              CanUserAddRows="False"
                                              CanUserDeleteRows="False"
                                              CanUserResizeRows="False"
                                              Style="{StaticResource CustomDataGridStyle}"
                                              SelectionMode="Single"
                                              RowBackground="{DynamicResource PrimaryBackgroundBrush}"
                                              AlternatingRowBackground="{DynamicResource SecondaryBackgroundBrush}"
                                              RowHeight="24"
                                              GridLinesVisibility="None"
                                              HeadersVisibility="Column"
                                              RowHeaderWidth="0"
                                              Background="Transparent"
                                              Margin="5">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Original"
                                                                Binding="{Binding Original}"
                                                                Width="*"
                                                                HeaderStyle="{StaticResource MultiRowHeaderStyle}"/>
                                            <DataGridTextColumn Header="New"
                                                                Binding="{Binding New}"
                                                                Width="*"
                                                                HeaderStyle="{StaticResource MultiRowHeaderStyle_NoRightBorder}"/>
                                        </DataGrid.Columns>
                                    </DataGrid>
                                </Grid>
                            </Border>

                            <!-- Action Buttons -->
                              <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center">
                                  <Button Content="Apply"
                                          Click="RenameApply_Click"
                                          Style="{StaticResource CustomActionButtonStyle}"
                                          Width="120" Height="35"
                                          FontSize="12"
                                          Margin="5,0,5,0"/>

                                  <Button Content="Cancel"
                                          Click="RenameCancel_Click"
                                          Style="{StaticResource NegativeActionButtonStyle}"
                                          Background="#FF555555"
                                          BorderBrush="#FF555555"
                                          Width="120" Height="35"
                                          FontSize="12"
                                          Margin="5,0,5,0"/>
                              </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>
        </Border>

        <!-- Resize edges -->
        <Border x:Name="LeftEdge" Width="5" HorizontalAlignment="Left" VerticalAlignment="Stretch"
                Background="Transparent" Cursor="SizeWE"
                MouseEnter="LeftEdge_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="LeftEdge_MouseLeftButtonDown" />
        <Border x:Name="RightEdge" Width="9" HorizontalAlignment="Right" VerticalAlignment="Stretch"
                Background="Transparent" Cursor="SizeWE"
                MouseEnter="RightEdge_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="RightEdge_MouseLeftButtonDown" />
        <Border x:Name="BottomEdge" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Bottom"
                Background="Transparent" Cursor="SizeNS"
                MouseEnter="BottomEdge_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="BottomEdge_MouseLeftButtonDown" />
        <Border x:Name="BottomLeftCorner" Width="10" Height="10" HorizontalAlignment="Left" VerticalAlignment="Bottom"
                Background="Transparent" Cursor="SizeNESW"
                MouseEnter="BottomLeftCorner_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="BottomLeftCorner_MouseLeftButtonDown" />
        <Border x:Name="BottomRightCorner" Width="10" Height="10" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                Background="Transparent" Cursor="SizeNWSE"
                MouseEnter="BottomRightCorner_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="BottomRightCorner_MouseLeftButtonDown" />
    </Grid>
</Window>
