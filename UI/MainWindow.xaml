<Window
    x:Class="PlaceViews.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:av="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:PlaceViews"
    xmlns:ui="clr-namespace:PlaceViews.UI"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Place Views"
    Width="800"
    Height="600"
    MinWidth="600"
    MinHeight="500"
    AllowsTransparency="True"
    Background="Transparent"
    WindowStyle="None"
    mc:Ignorable="av">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary>
                    <SolidColorBrush x:Key="PrimaryBackgroundBrush" Color="#FF1F1F1F" />
                    <SolidColorBrush x:Key="SecondaryBackgroundBrush" Color="#FF292929" />
                    <SolidColorBrush x:Key="BorderBrush" Color="#FF444444" />
                    <SolidColorBrush x:Key="ForegroundBrush" Color="#EEEEEE" />
                </ResourceDictionary>
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.ComboBox.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesignTheme.Dark.xaml" />
                <ResourceDictionary Source="pack://application:,,,/PlaceViews;component/UI/Themes/ElementStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>


    <Grid Background="Transparent" ClipToBounds="True">
        <!-- Outer Border with Opacity and Blur -->
        <Border
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="2"
            ClipToBounds="True"
            CornerRadius="10"
            Opacity="0.7"
            SnapsToDevicePixels="True">
            <Border.Effect>
                <BlurEffect KernelType="Gaussian" Radius="2" />
            </Border.Effect>
        </Border>

        <!-- Content Container -->
        <Border
            Margin="2"
            Background="{DynamicResource PrimaryBackgroundBrush}"
            CornerRadius="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="30" />
                    <!-- Row 0: Title bar -->
                    <RowDefinition Height="*" />
                    <!-- Row 1: Content -->
                    <RowDefinition Height="Auto" />
                    <!-- Row 2: Actions -->
                </Grid.RowDefinitions>

                <!-- Title bar (Row 0) -->
                <ui:TitleBar
                    Grid.Row="0"
                    Foreground="{DynamicResource ForegroundBrush}"
                    Loaded="TitleBar_Loaded" />

                <!-- Theme toggle -->
                <ToggleButton
                    x:Name="ThemeToggleButton"
                    Grid.Row="0"
                    Width="28"
                    Height="15.5"
                    Margin="0,0,70,0"
                    HorizontalAlignment="Right"
                    Background="Transparent"
                    BorderBrush="Transparent"
                    Click="ToggleTheme_Click"
                    IsChecked="True"
                    ToolTip="Toggle Theme">
                    <ToggleButton.Template>
                        <ControlTemplate TargetType="{x:Type ToggleButton}">
                            <Grid Background="Transparent">
                                <materialDesign:PackIcon
                                    x:Name="ThemeToggleIcon"
                                    Width="30"
                                    Height="30"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Foreground="{DynamicResource IconBrush}"
                                    Kind="ToggleSwitchOffOutline" />
                            </Grid>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsChecked" Value="True">
                                    <Setter TargetName="ThemeToggleIcon" Property="Kind" Value="ToggleSwitchOffOutline" />
                                </Trigger>
                                <Trigger Property="IsChecked" Value="False">
                                    <Setter TargetName="ThemeToggleIcon" Property="Kind" Value="ToggleSwitchOutline" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </ToggleButton.Template>
                </ToggleButton>

                <!-- Main Content (Row 1) -->
                <Grid Grid.Row="1" Margin="10,10,10,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="20" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Views List -->
                    <GroupBox Grid.Column="0" Header="Available Views" 
                              Margin="0"
                              Style="{StaticResource CustomGroupBoxStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Search Box with Magnify Icon -->
                            <Border Grid.Row="0" Margin="0,0,0,5"
                                    Height="24"
                                    Background="{DynamicResource SecondaryBackgroundBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Opacity="0.95">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="28"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="28"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <materialDesign:PackIcon Kind="Magnify"
                                                           Grid.Column="0"
                                                           Width="16" Height="16"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           Foreground="{DynamicResource IconBrush}"/>
                                    
                                    <TextBlock Grid.Column="1"
                                              Text="Search views..."
                                              Foreground="#FF808080"
                                              VerticalAlignment="Center"
                                              Margin="2,0,0,0"
                                              IsHitTestVisible="False">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=ViewSearchBox}" Value="">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <TextBox Grid.Column="1"
                                             x:Name="ViewSearchBox"
                                             Style="{StaticResource CustomTextBoxStyle}"
                                             Height="Auto"
                                             VerticalAlignment="Center"
                                             HorizontalAlignment="Stretch"
                                             Background="Transparent"
                                             BorderThickness="0"
                                             TextChanged="ViewSearch_TextChanged"/>
                                    
                                    <Button Grid.Column="2"
                                            Width="24"
                                            Height="24"
                                            Click="ClearViewSearch_Click"
                                            ToolTip="Clear search"
                                            Style="{StaticResource FlatIconButton}">
                                        <materialDesign:PackIcon Kind="CloseCircleOutline" 
                                                                Width="14" 
                                                                Height="14"
                                                                Foreground="{DynamicResource IconBrush}"/>
                                    </Button>
                                </Grid>
                            </Border>
                            
                            <DataGrid Grid.Row="1"
                                      x:Name="ViewsDataGrid"
                                      ItemsSource="{Binding FilteredViews}" 
                                      AutoGenerateColumns="False" 
                                      CanUserAddRows="False" 
                                      CanUserDeleteRows="False" 
                                      CanUserResizeRows="False"
                                      Style="{StaticResource CustomDataGridStyle}"
                                      SelectionMode="Extended"
                                      SelectionUnit="FullRow"
                                      AlternatingRowBackground="{DynamicResource SecondaryBackgroundBrush}"
                                      RowBackground="{DynamicResource PrimaryBackgroundBrush}"
                                      RowHeight="20"
                                      GridLinesVisibility="None"
                                      HeadersVisibility="Column"
                                      RowHeaderWidth="0"
                                      Background="{DynamicResource PrimaryBackgroundBrush}"
                                      HorizontalScrollBarVisibility="Disabled"
                                      VerticalScrollBarVisibility="Auto"
                                      KeyDown="ViewsDataGrid_KeyDown"
                                      BeginningEdit="DataGrid_BeginningEdit">
                                <DataGrid.Columns>
                                    <DataGridTemplateColumn Width="35" HeaderStyle="{StaticResource MultiRowHeaderStyle}">
                                        <DataGridTemplateColumn.Header>
                                            <CheckBox Style="{StaticResource DatagridCheckboxStyle}"
                                                      HorizontalAlignment="Center"
                                                      Checked="SelectAllViews_Checked"
                                                      Unchecked="SelectAllViews_Unchecked"
                                                      ToolTip="Select/Deselect All Visible"/>
                                        </DataGridTemplateColumn.Header>
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                                                    <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                             Style="{StaticResource DatagridCheckboxStyle}"
                                                             Focusable="False"
                                                             PreviewMouseLeftButtonDown="ViewCheckBox_PreviewMouseLeftButtonDown"/>
                                                </Grid>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" IsReadOnly="True" Width="*" HeaderStyle="{StaticResource MultiRowHeaderStyle}"/>
                                    <DataGridTextColumn Header="Type" Binding="{Binding ViewType}" IsReadOnly="True" Width="Auto" HeaderStyle="{StaticResource MultiRowHeaderStyle_NoRightBorder}" ElementStyle="{StaticResource CenterAlignedCellStyle}"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </GroupBox>

                    <!-- Sheets List -->
                    <GroupBox Grid.Column="2" Header="Sheets" 
                              Margin="0"
                              Style="{StaticResource CustomGroupBoxStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Search Box with Magnify Icon -->
                            <Border Grid.Row="0" Margin="0,0,0,5"
                                    Height="24"
                                    Background="{DynamicResource SecondaryBackgroundBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Opacity="0.95">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="28"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="28"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <materialDesign:PackIcon Kind="Magnify"
                                                           Grid.Column="0"
                                                           Width="16" Height="16"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           Foreground="{DynamicResource IconBrush}"/>
                                    
                                    <TextBlock Grid.Column="1"
                                              Text="Search sheets..."
                                              Foreground="#FF808080"
                                              VerticalAlignment="Center"
                                              Margin="2,0,0,0"
                                              IsHitTestVisible="False">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, ElementName=SheetSearchBox}" Value="">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <TextBox Grid.Column="1"
                                             x:Name="SheetSearchBox"
                                             Style="{StaticResource CustomTextBoxStyle}"
                                             Height="Auto"
                                             VerticalAlignment="Center"
                                             HorizontalAlignment="Stretch"
                                             Background="Transparent"
                                             BorderThickness="0"
                                             TextChanged="SheetSearch_TextChanged"/>
                                    
                                    <Button Grid.Column="2"
                                            Width="24"
                                            Height="24"
                                            Click="ClearSheetSearch_Click"
                                            ToolTip="Clear search"
                                            Style="{StaticResource FlatIconButton}">
                                        <materialDesign:PackIcon Kind="CloseCircleOutline" 
                                                                Width="14" 
                                                                Height="14"
                                                                Foreground="{DynamicResource IconBrush}"/>
                                    </Button>
                                </Grid>
                            </Border>
                            
                            <DataGrid Grid.Row="1"
                                      x:Name="SheetsDataGrid"
                                      ItemsSource="{Binding FilteredSheets}" 
                                      AutoGenerateColumns="False" 
                                      CanUserAddRows="False" 
                                      CanUserDeleteRows="False" 
                                      CanUserResizeRows="False"
                                      Style="{StaticResource CustomDataGridStyle}"
                                      SelectionMode="Extended"
                                      SelectionUnit="FullRow"
                                      AlternatingRowBackground="{DynamicResource SecondaryBackgroundBrush}"
                                      RowBackground="{DynamicResource PrimaryBackgroundBrush}"
                                      RowHeight="20"
                                      GridLinesVisibility="None"
                                      HeadersVisibility="Column"
                                      RowHeaderWidth="0"
                                      Background="{DynamicResource PrimaryBackgroundBrush}"
                                      HorizontalScrollBarVisibility="Disabled"
                                      VerticalScrollBarVisibility="Auto"
                                      KeyDown="SheetsDataGrid_KeyDown"
                                      BeginningEdit="DataGrid_BeginningEdit">
                                <DataGrid.Columns>
                                    <DataGridTemplateColumn Width="35" HeaderStyle="{StaticResource MultiRowHeaderStyle}">
                                        <DataGridTemplateColumn.Header>
                                            <CheckBox Style="{StaticResource DatagridCheckboxStyle}"
                                                      HorizontalAlignment="Center"
                                                      Checked="SelectAllSheets_Checked"
                                                      Unchecked="SelectAllSheets_Unchecked"
                                                      ToolTip="Select/Deselect All Visible"/>
                                        </DataGridTemplateColumn.Header>
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                                                    <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                             Style="{StaticResource DatagridCheckboxStyle}"
                                                             Focusable="False"
                                                             PreviewMouseLeftButtonDown="SheetCheckBox_PreviewMouseLeftButtonDown"/>
                                                </Grid>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" IsReadOnly="True" Width="*" HeaderStyle="{StaticResource MultiRowHeaderStyle_NoRightBorder}"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </GroupBox>
                </Grid>

                <!-- Actions (Row 2) -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,15,0,15">
                    <Button Content="Place Views" 
                            Click="PlaceViews_Click" 
                            Style="{StaticResource CustomActionButtonStyle}"
                            Width="250" Height="40" FontSize="14" FontWeight="Bold"/>
                </StackPanel>

                <!-- Popup Overlay -->
                <Grid x:Name="PopupOverlay" Grid.RowSpan="3" Visibility="Collapsed" Panel.ZIndex="1000">
                    <!-- Dim Background -->
                    <Border Background="#80000000" MouseLeftButtonDown="PopupBackground_Click"/>

                    <!-- Popup Content -->
                    <Border HorizontalAlignment="Center" 
                            VerticalAlignment="Center"
                            Width="300"
                            Padding="20"
                            Background="{DynamicResource PrimaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="8">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="15" Direction="-90" RenderingBias="Quality" ShadowDepth="2" Opacity="0.4"/>
                        </Border.Effect>

                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock x:Name="PopupTitle" 
                                       Grid.Row="0"
                                       Text="Title" 
                                       FontSize="16" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,10"/>

                            <TextBlock x:Name="PopupMessage" 
                                       Grid.Row="1"
                                       Text="Message content goes here." 
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       Margin="0,0,0,20"/>

                            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button x:Name="PopupCloseButton"
                                        Content="OK"
                                        Click="PopupClose_Click"
                                        Style="{StaticResource CustomActionButtonStyle}"
                                        Width="80" 
                                        Height="30"
                                        FontSize="12"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>
        </Border>

        <!-- Resize edges (Keep existing) -->
        <Border x:Name="LeftEdge" Width="5" HorizontalAlignment="Left" VerticalAlignment="Stretch"
                Background="Transparent" Cursor="SizeWE"
                MouseEnter="LeftEdge_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="LeftEdge_MouseLeftButtonDown" />
        <Border x:Name="RightEdge" Width="9" HorizontalAlignment="Right" VerticalAlignment="Stretch"
                Background="Transparent" Cursor="SizeWE"
                MouseEnter="RightEdge_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="RightEdge_MouseLeftButtonDown" />
        <Border x:Name="BottomEdge" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Bottom"
                Background="Transparent" Cursor="SizeNS"
                MouseEnter="BottomEdge_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="BottomEdge_MouseLeftButtonDown" />
        <Border x:Name="BottomLeftCorner" Width="10" Height="10" HorizontalAlignment="Left" VerticalAlignment="Bottom"
                Background="Transparent" Cursor="SizeNESW"
                MouseEnter="BottomLeftCorner_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="BottomLeftCorner_MouseLeftButtonDown" />
        <Border x:Name="BottomRightCorner" Width="10" Height="10" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                Background="Transparent" Cursor="SizeNWSE"
                MouseEnter="BottomRightCorner_MouseEnter" MouseLeave="Edge_MouseLeave"
                MouseLeftButtonDown="BottomRightCorner_MouseLeftButtonDown" />
    </Grid>
</Window>
